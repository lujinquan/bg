<style>
    .page-tab-content{margin: 40px;}
</style>
<div class="layui-tab layui-tab-brief j-no-color">
  <ul class="layui-tab-title">
    <li class="layui-this">编辑账号</li>
  </ul>
</div>
<form class="layui-form j-top-margin" action="{:url()}" method="post" id="addForm">
    <div class="layui-form-item">
        <div class="layui-inline">
          <label class="layui-form-label"><i class="red">*</i>账号名称：</label>
          <div class="layui-input-inline">
            {$data_info['username']}
          </div>
        </div>
    </div>
    <div class="layui-form-item">
        <div class="layui-inline">
          <label class="layui-form-label"><i class="red">*</i>真实姓名：</label>
          <div class="layui-input-inline">
            {$data_info['nick']}
          </div>
        </div>
     </div>
     <div class="layui-form-item">
        <label class="layui-form-label">角色分组：</label>
        <div class="layui-input-inline">
            <select name="role_id" class="field-role_id" type="select">
                <!-- <option value="">请选择</option> -->
                {volist name="roleArr" id="v"}
                <option value="{$key}" {if condition="$key == $data_info['role_id']"}selected{/if}>{$v}</option>
                {/volist}
            </select>
        </div>
    </div>
     <div class="layui-form-item">
        <div class="layui-inline">
          <label class="layui-form-label">职务：</label>
          <div class="layui-input-inline">
            <input type="tel" name="post" value="{$data_info['post']}" placeholder="请输入职务" lay-verType="tips" autocomplete="off" class="layui-input">
          </div>
        </div>
    </div>   
    <div class="layui-form-item">
        <div class="layui-inline">
          <label class="layui-form-label">备注：</label>
          <div class="layui-input-inline">
            <textarea name="remark" placeholder="备注描述" lay-verType="tips" class="layui-textarea">{$data_info['remark']}</textarea>
          </div>
        </div>
    </div>   
    <div class="layui-form-item" pane="">
        <label class="layui-form-label"><i class="red"></i>门禁：</label>
        <div class="layui-input-block j-input-width">

          <select name="guard_group_id" class="field-role_id" lay-filter="filter" type="select">
                <option value="">请选择</option>
                {volist name="guardArr" id="v"}
                {if condition="$v['pid'] == 0"}
                <option value="{$v['id']}" {if condition="$v['id'] == $data_info['guard_group_id']"}selected{/if}>{$v['title']}</option>
                {/if}
                {/volist}
            </select>
        </div>
    </div>
    <div class="layui-form-item">
          <label class="layui-form-label"></label>
          <div class="layui-input-block">

            <div id="firstpane" class="menu_list">
              {volist name="guardArr"  id="v"}
              {if condition="$v['id'] == $data_info['guard_group_id']"}
              {volist name="v['childs']" key="k" id="vv"}
              <div class="menu_head {if condition='$k == 1'}current{/if}">
                <input type="checkbox" name="ban[]" value="{$vv['id']}" title="{$vv['title']}" {if condition="in_array($vv['id'],$data_info['guard']['ban'])"}checked{/if} lay-skin="primary" lay-filter="chooseAll" class="chooseAllMessage">
                <b class="j-icon"></b>
              </div>  
              <div class="menu_body {if condition='$k != 1'}hide{/if}">
                <dl class="clearfix">
                  {volist name="vv['childs']" id="vvv"}
                  <dt class="clearfix">
                    <input type="checkbox" name="floor[]" value="{$vvv['id']}" title="{$vvv['title']}" {if condition="in_array($vvv['id'],$data_info['guard']['floor'])"}checked{/if} lay-skin="primary" lay-filter="secondAll" class="secondAllMessage list">
                  </dt>
                  <dd class="clearfix">
                    <ul>
                      {volist name="vvv['childs']" id="vvvv"}
                      <li>
                        <input type="checkbox" name="guard[]" value="{$vvvv['id']}" title="{$vvvv['title']}" {if condition="in_array($vvvv['id'],$data_info['guard']['guard'])"}checked{/if} lay-skin="primary" lay-filter="list" class="listMessage list">
                      </li>
                      {/volist}
                    </ul>
                  </dd>
                  {/volist}
                </dl>
              </div>
              {/volist}
              {/if}
              {/volist}
            </div>
          </div>
    </div>
    <input type="hidden" name="id" value="{$data_info['id']}">
    <div class="layui-form-item">
        <div class="layui-input-block">
          <button type="reset" class="layui-btn layui-btn-primary">取消</button>
          <button class="layui-btn layui-btn-normal" lay-submit="" lay-filter="formSubmit">提交</button>
        </div>
     </div>
</form>
{include file="block/layui" /}
<script>    
layui.use(['form','layer','jquery'], function(){
  var layer = layui.layer
      $= layui.jquery;
   var   form = layui.form;



  
  form.on('select(filter)', function(data){
    var guards = {:json_encode($guardArr)};
    //console.log(guards);
    for (var i = 0 ; i < guards.length ; i++) {
      if(guards[i].id == data.value){
        var bans = guards[i].childs;
        var str = '';

        if(bans.length > 0){
          for (var j = 0 ; j < bans.length ; j++) {
            if(j==0){
              var current = 'current';
        var hide = '';
            }else{
              var current = '';
        var hide = 'hide';
            }
            str += '<div class="menu_head '+current+'"><input type="checkbox" name="ban[]" value="'+ bans[j].id +'" title="'+bans[j].title +'"  lay-skin="primary" lay-filter="chooseAll" class="chooseAllMessage"><b class="j-icon"></b></div><div class="menu_body '+hide+'" >';
            var floors = bans[j].childs;

            if(floors.length > 0){
              for (var k = 0 ; k < floors.length ; k++) {
                str += '<dl class="clearfix">\
                          <dt class="clearfix"><input type="checkbox" name="floor[]" value="'+ floors[k].id +'" title="'+ floors[k].title+'"  lay-skin="primary" lay-filter="secondAll" class="secondAllMessage list"></dt><dd class="clearfix">\
                              <ul>';
                var guards = floors[k].childs;
                if(guards.length > 0){
                  for (var h = 0 ; h < guards.length ; h++) {
                    str += '<li>\
                               <input type="checkbox" name="guard[]" value="'+ guards[h].id +'" title="'+guards[h].title+'"  lay-skin="primary" lay-filter="list" class="listMessage list"> \
                            </li>';
                  }
                }
                str += '</ul>\
                          </dd></dl>';
              }  
            }
            str += '</div>';

          }   
          str += '</div>';     
          //console.log(str);
          $('#firstpane').html(str);
          form.render();
        }
        
      }
    }
  }); 


  //监听折叠
 
  $("#firstpane").on('click','.menu_head .j-icon',function(){
     if ($(this).parent().hasClass("current")) {
          $(this).parent().removeClass("current").siblings("div.menu_body").slideUp("slow");
      }
      else {
        $(this).parent().addClass("current").next("div.menu_body").slideToggle(300).siblings("div.menu_body").slideUp("slow");
        $(this).parent().siblings().removeClass("current");
      }
  });     
   //楼栋全选 
      form.on('checkbox(chooseAll)', function (data) {
      var that = $(this);
      var a = data.elem.checked;
        $("input[name='guard[]'],input[name='floor[]']").each(function () {
       if (a == true) {
        that.parent().next("div.menu_body").find(".list").prop('checked',true);
        form.render('checkbox');
      } else {
        that.parent().next("div.menu_body").find(".list").prop('checked',false);
        form.render('checkbox');
      }
      
        });
      });
    //楼层全选
    form.on('checkbox(secondAll)', function (data) {
          var that = $(this);
          var b = data.elem.checked;
      $("input[name='guard[]'],input[name='floor[]']").each(function () {
           if (b == true) {
            that.parent().next().find(".list").prop('checked',true);
          that.parents(".menu_body").prev().find(".chooseAllMessage").prop('checked',true);
            form.render('checkbox');
          } else {
            that.parent().next().find(".list").prop('checked',false);
          //that.parents(".menu_body").prev().find(".chooseAllMessage").prop('checked',false);
            form.render('checkbox');
          }
          
      });
    });
      //判断层级勾选
    form.on('checkbox(list)', function (data) {
     var that = $(this);
     var c = data.elem.checked;
      if(c == true)
      {
        that.parents("dd").prev().find(".list").prop('checked',true);
        form.render('checkbox');
      }
      else{
        //that.parents("dd").prev().find(".list").prop('checked',false);
        form.render('checkbox');
      }
      
   });  

 })
</script>